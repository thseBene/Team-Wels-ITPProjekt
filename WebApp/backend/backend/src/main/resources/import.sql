-- Import / Schema-Skript (angepasst: keine direkte Verknüpfung von feedback zu thema/kategorie)
-- Läuft auf PostgreSQL.

-- Reihenfolge beachten: erst dependent objects löschen, dann neu anlegen
DROP TABLE IF EXISTS notification CASCADE;
DROP TABLE IF EXISTS feedback_kategorie CASCADE; -- Join-Tabelle entfernt
DROP TABLE IF EXISTS bild CASCADE;
DROP TABLE IF EXISTS feedback CASCADE;
DROP TABLE IF EXISTS kategorie CASCADE;
DROP TABLE IF EXISTS thema CASCADE;
DROP TABLE IF EXISTS benutzer CASCADE;

-- Benutzer (mit UNIQUE constraints)
CREATE TABLE benutzer (
                          id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
                          mail VARCHAR(255),
                          tel VARCHAR(50),
                          rolle VARCHAR(50) NOT NULL,
                          CONSTRAINT benutzer_tel_unique UNIQUE (tel),
                          CONSTRAINT benutzer_mail_unique UNIQUE (mail)
);

-- Thema (bleibt bestehen, aber Feedback referenziert es nicht mehr)
CREATE TABLE thema (
                       id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
                       bezeichnung VARCHAR(150) NOT NULL
);

-- Kategorie (bleibt bestehen)
CREATE TABLE kategorie (
                           id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
                           bezeichnung VARCHAR(150) NOT NULL
);

-- Feedback (ohne thema_id)
CREATE TABLE feedback (
                          id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
                          betreff VARCHAR(255) NOT NULL,
                          beschreibung TEXT NOT NULL,
                          typ VARCHAR(100) NOT NULL,
                          status VARCHAR(100) NOT NULL,
                          created_at TIMESTAMP WITHOUT TIME ZONE NOT NULL DEFAULT NOW(),
                          updated_at TIMESTAMP WITHOUT TIME ZONE NOT NULL DEFAULT NOW(),
                          user_id BIGINT REFERENCES benutzer(id) ON DELETE SET NULL
    -- thema_id entfernt, join-table feedback_kategorie wird nicht erstellt
);

-- Bild (falls du Bilder benutzt)
CREATE TABLE bild (
                      id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
                      pfad VARCHAR(1024) NOT NULL,
                      beschreibung TEXT,
                      feedback_id BIGINT REFERENCES feedback(id) ON DELETE CASCADE
);

-- Notification Tabelle
CREATE TABLE notification (
                              id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
                              typ VARCHAR(50) NOT NULL,
                              nachricht TEXT NOT NULL,
                              betreff VARCHAR(255),
                              gelesen BOOLEAN NOT NULL DEFAULT FALSE,
                              created_at TIMESTAMP WITHOUT TIME ZONE NOT NULL DEFAULT NOW(),
                              benutzer_id BIGINT REFERENCES benutzer(id) ON DELETE CASCADE
);

-- Indexes
CREATE INDEX idx_feedback_user ON feedback(user_id);
CREATE INDEX idx_notification_benutzer ON notification(benutzer_id);
CREATE INDEX idx_notification_gelesen ON notification(gelesen);

-- -------------------------
-- Beispiel-Daten einfügen
-- -------------------------

-- Themen
INSERT INTO thema (bezeichnung) VALUES
                                    ('Infrastruktur'),
                                    ('Service'),
                                    ('IT');

-- Kategorien
INSERT INTO kategorie (bezeichnung) VALUES
                                        ('Sicherheit'),
                                        ('Sauberkeit'),
                                        ('Funktionalität'),
                                        ('Sonstiges');

-- Benutzer
INSERT INTO benutzer (mail, tel, rolle) VALUES
                                            ('alice.muster@htl.at', '+43 664 1234567', 'student'),
                                            ('bob.beispiel@htl.at', '+43 664 2345678', 'student'),
                                            ('charlie.test@htl.at', '+43 664 3456789', 'lehrer'),
                                            ('diana.demo@htl.at', '+43 664 4567890', 'admin');

-- Feedbacks (ohne thema_id)
INSERT INTO feedback (betreff, beschreibung, typ, status, created_at, updated_at, user_id)
VALUES
    ('Kaputte Tür', 'Die Tür im Raum 12 klemmt und lässt sich schwer öffnen.', 'Beschwerde', 'NEU', NOW(), NOW(), 1),
    ('Sauberkeit Mensa', 'In der Mensa liegen oft Essensreste auf dem Boden.', 'Beschwerde', 'IN_BEARBEITUNG', NOW(), NOW(), 2),
    ('Tolles Update', 'Das neue Login-Feature funktioniert sehr gut.', 'Lob', 'ERLEDIGT', NOW(), NOW(), 3),
    ('WLAN Aussetzer', 'Das WLAN bricht im Gebäude C mehrfach täglich ab.', 'Beschwerde', 'NEU', NOW(), NOW(), 1);

-- Bilder (falls)
INSERT INTO bild (pfad, beschreibung, feedback_id) VALUES
    ('/images/door.jpg', 'Tür klemmt', 1);

-- Sequenzen / Identitys auf Max setzen (GREATEST(...,1) verhindert setval 0 Fehler)
SELECT setval(pg_get_serial_sequence('benutzer','id'),
              GREATEST((SELECT COALESCE(MAX(id),0) FROM benutzer), 1), true);

SELECT setval(pg_get_serial_sequence('thema','id'),
              GREATEST((SELECT COALESCE(MAX(id),0) FROM thema), 1), true);

SELECT setval(pg_get_serial_sequence('kategorie','id'),
              GREATEST((SELECT COALESCE(MAX(id),0) FROM kategorie), 1), true);

SELECT setval(pg_get_serial_sequence('feedback','id'),
              GREATEST((SELECT COALESCE(MAX(id),0) FROM feedback), 1), true);

SELECT setval(pg_get_serial_sequence('bild','id'),
              GREATEST((SELECT COALESCE(MAX(id),0) FROM bild), 1), true);

SELECT setval(pg_get_serial_sequence('notification','id'),
              GREATEST((SELECT COALESCE(MAX(id),0) FROM notification), 1), true);

-- Ende des Import-Skripts