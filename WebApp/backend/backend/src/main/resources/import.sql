<<<<<<< Updated upstream
-- Import / Schema-Skript (erweitert um Mitarbeiter-Verwaltung)
-- Läuft auf PostgreSQL.

-- Reihenfolge beachten:  erst dependent objects löschen, dann neu anlegen
DROP TABLE IF EXISTS notification CASCADE;
DROP TABLE IF EXISTS mitarbeiter CASCADE;
DROP TABLE IF EXISTS bild CASCADE;
DROP TABLE IF EXISTS feedback CASCADE;
DROP TABLE IF EXISTS kategorie CASCADE;
DROP TABLE IF EXISTS thema CASCADE;
DROP TABLE IF EXISTS benutzer CASCADE;

-- Benutzer (Basis-Tabelle für alle User-Typen)
CREATE TABLE benutzer (
                          id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
                          mail VARCHAR(255),
                          tel VARCHAR(50),
                          rolle VARCHAR(50) NOT NULL,
                          CONSTRAINT benutzer_tel_unique UNIQUE (tel),
                          CONSTRAINT benutzer_mail_unique UNIQUE (mail)
);

-- Mitarbeiter (erweiterte Tabelle nur für Mitarbeiter)
CREATE TABLE mitarbeiter (
                             id BIGINT PRIMARY KEY,
                             benutzername VARCHAR(100) NOT NULL UNIQUE,
                             passwort VARCHAR(255) NOT NULL,
                             vorname VARCHAR(100) NOT NULL,
                             nachname VARCHAR(100) NOT NULL,
                             abteilung VARCHAR(100),
                             aktiv BOOLEAN NOT NULL DEFAULT TRUE,
                             letzter_login TIMESTAMP WITHOUT TIME ZONE,
                             CONSTRAINT fk_mitarbeiter_benutzer
                                 FOREIGN KEY (id) REFERENCES benutzer(id) ON DELETE CASCADE
);

-- Thema (bleibt bestehen, aber Feedback referenziert es nicht mehr)
CREATE TABLE thema (
                       id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
                       bezeichnung VARCHAR(150) NOT NULL
);

-- Kategorie (bleibt bestehen)
CREATE TABLE kategorie (
                           id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
                           bezeichnung VARCHAR(150) NOT NULL
);

-- Feedback (ohne thema_id)
CREATE TABLE feedback (
                          id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
                          betreff VARCHAR(255) NOT NULL,
                          beschreibung TEXT NOT NULL,
                          typ VARCHAR(100) NOT NULL,
                          status VARCHAR(100) NOT NULL,
                          created_at TIMESTAMP WITHOUT TIME ZONE NOT NULL DEFAULT NOW(),
                          updated_at TIMESTAMP WITHOUT TIME ZONE NOT NULL DEFAULT NOW(),
                          user_id BIGINT REFERENCES benutzer(id) ON DELETE SET NULL
);

-- Bild (falls du Bilder benutzt)
CREATE TABLE bild (
                      id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
                      pfad VARCHAR(1024) NOT NULL,
                      beschreibung TEXT,
                      feedback_id BIGINT REFERENCES feedback(id) ON DELETE CASCADE
);

-- Notification Tabelle
CREATE TABLE notification (
                              id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
                              typ VARCHAR(50) NOT NULL,
                              nachricht TEXT NOT NULL,
                              betreff VARCHAR(255),
                              gelesen BOOLEAN NOT NULL DEFAULT FALSE,
                              created_at TIMESTAMP WITHOUT TIME ZONE NOT NULL DEFAULT NOW(),
                              benutzer_id BIGINT REFERENCES benutzer(id) ON DELETE CASCADE
);

-- Indexes
CREATE INDEX idx_feedback_user ON feedback(user_id);
CREATE INDEX idx_notification_benutzer ON notification(benutzer_id);
CREATE INDEX idx_notification_gelesen ON notification(gelesen);
CREATE INDEX idx_mitarbeiter_benutzername ON mitarbeiter(benutzername);
CREATE INDEX idx_mitarbeiter_aktiv ON mitarbeiter(aktiv);

-- -------------------------
-- Beispiel-Daten einfügen
-- -------------------------

-- Themen
INSERT INTO thema (bezeichnung) VALUES
                                    ('Infrastruktur'),
                                    ('Service'),
                                    ('IT');

-- Kategorien
INSERT INTO kategorie (bezeichnung) VALUES
                                        ('Sicherheit'),
                                        ('Sauberkeit'),
                                        ('Funktionalität'),
                                        ('Sonstiges');

-- -------------------------
-- Normale Benutzer (Bürger)
-- -------------------------
INSERT INTO benutzer (mail, tel, rolle) VALUES
                                            ('alice.muster@htl.at', null, 'nutzer'),
                                            ('bob.beispiel@htl.at', null, 'nutzer'),
                                            ('charlie.test@htl.at', null, 'nutzer'),
                                            ('diana.demo@gmail.com', null, 'nutzer'),
                                            ('erik.example@outlook.com', null, 'nutzer');

-- -------------------------
-- Mitarbeiter
-- -------------------------

-- Admin Mitarbeiter
INSERT INTO benutzer (mail, tel, rolle) VALUES
    ('admin@teamwels.at', null, 'mitarbeiter');

INSERT INTO mitarbeiter (id, benutzername, passwort, vorname, nachname, abteilung, aktiv) VALUES
    (
        (SELECT id FROM benutzer WHERE mail = 'admin@teamwels.at'),
        'admin',
        'admin123',
        'Max',
        'Administrator',
        'IT',
        true
    );

-- IT Support Mitarbeiter
INSERT INTO benutzer (mail, tel, rolle) VALUES
    ('lisa.tech@teamwels.at', null, 'mitarbeiter');

INSERT INTO mitarbeiter (id, benutzername, passwort, vorname, nachname, abteilung, aktiv) VALUES
    (
        (SELECT id FROM benutzer WHERE mail = 'lisa.tech@teamwels.at'),
        'lisa.tech',
        'techSupport2024',
        'Lisa',
        'Techniker',
        'IT Support',
        true
    );

-- Facility Management Mitarbeiter
INSERT INTO benutzer (mail, tel, rolle) VALUES
    ('thomas.bau@teamwels.at', null, 'mitarbeiter');

INSERT INTO mitarbeiter (id, benutzername, passwort, vorname, nachname, abteilung, aktiv) VALUES
    (
        (SELECT id FROM benutzer WHERE mail = 'thomas.bau@teamwels.at'),
        'thomas.bau',
        'facility2024',
        'Thomas',
        'Bauer',
        'Facility Management',
        true
    );

-- Service Desk Mitarbeiterin
INSERT INTO benutzer (mail, tel, rolle) VALUES
    ('anna.service@teamwels.at', null, 'mitarbeiter');

INSERT INTO mitarbeiter (id, benutzername, passwort, vorname, nachname, abteilung, aktiv) VALUES
    (
        (SELECT id FROM benutzer WHERE mail = 'anna.service@teamwels.at'),
        'anna.service',
        'service2024',
        'Anna',
        'Müller',
        'Service Desk',
        true
    );

-- Inaktiver Mitarbeiter (zum Testen)
INSERT INTO benutzer (mail, tel, rolle) VALUES
    ('ex.worker@teamwels.at', null, 'mitarbeiter');

INSERT INTO mitarbeiter (id, benutzername, passwort, vorname, nachname, abteilung, aktiv) VALUES
    (
        (SELECT id FROM benutzer WHERE mail = 'ex.worker@teamwels.at'),
        'ex.worker',
        'old2024',
        'Franz',
        'Alt',
        'Verwaltung',
        false  -- Nicht mehr aktiv
    );

-- -------------------------
-- Feedback (von normalen Benutzern)
-- -------------------------
INSERT INTO feedback (betreff, beschreibung, typ, status, user_id) VALUES
                                                                       (
                                                                           'Defekte Straßenbeleuchtung',
                                                                           'Die Straßenbeleuchtung in der Hauptstraße 45 ist seit 3 Tagen defekt.',
                                                                           'Beschwerde',
                                                                           'NEU',
                                                                           (SELECT id FROM benutzer WHERE mail = 'alice.muster@htl.at')
                                                                       ),
                                                                       (
                                                                           'Toller neuer Spielplatz',
                                                                           'Der neue Spielplatz im Stadtpark ist wirklich gelungen!  Meine Kinder lieben ihn.',
                                                                           'Lob',
                                                                           'ERLEDIGT',
                                                                           (SELECT id FROM benutzer WHERE mail = 'bob.beispiel@htl. at')
                                                                       ),
                                                                       (
                                                                           'Müll nicht abgeholt',
                                                                           'Die Mülltonne wurde diese Woche nicht geleert.',
                                                                           'Beschwerde',
                                                                           'IN_BEARBEITUNG',
                                                                           (SELECT id FROM benutzer WHERE mail = 'charlie.test@htl. at')
                                                                       ),
                                                                       (
                                                                           'Anfrage zu Öffnungszeiten',
                                                                           'Sind die Öffnungszeiten des Bürgerservices auch am Samstag? ',
                                                                           'Anfrage',
                                                                           'NEU',
                                                                           (SELECT id FROM benutzer WHERE mail = 'diana.demo@gmail.com')
                                                                       ),
                                                                       (
                                                                           'Schlagloch in der Parkstraße',
                                                                           'Großes Schlagloch vor Hausnummer 12. Sehr gefährlich für Radfahrer! ',
                                                                           'Beschwerde',
                                                                           'NEU',
                                                                           (SELECT id FROM benutzer WHERE mail = 'erik.example@outlook.com')
                                                                       );

-- -------------------------
-- Notifications
-- -------------------------
INSERT INTO notification (typ, betreff, nachricht, gelesen, benutzer_id) VALUES
                                                                             (
                                                                                 'EMAIL',
                                                                                 'Feedback Status-Update:  Defekte Straßenbeleuchtung',
                                                                                 'Sehr geehrte/r Benutzer, Ihr Feedback "Defekte Straßenbeleuchtung" ist bei uns angekommen. Mit freundlichen Grüßen, Ihr Team Wels',
                                                                                 false,
                                                                                 (SELECT id FROM benutzer WHERE mail = 'alice.muster@htl.at')
                                                                             ),
                                                                             (
                                                                                 'SMS',
                                                                                 null,
                                                                                 'Feedback:  "Defekte Straßenbeleuchtung" ist bei uns angekommen',
                                                                                 false,
                                                                                 (SELECT id FROM benutzer WHERE mail = 'alice.muster@htl.at')
                                                                             ),
                                                                             (
                                                                                 'EMAIL',
                                                                                 'Feedback Status-Update: Toller neuer Spielplatz',
                                                                                 'Sehr geehrte/r Benutzer, Ihr Feedback "Toller neuer Spielplatz" wurde bearbeitet. Mit freundlichen Grüßen, Ihr Team Wels',
                                                                                 true,
                                                                                 (SELECT id FROM benutzer WHERE mail = 'bob.beispiel@htl.at')
                                                                             ),
                                                                             (
                                                                                 'EMAIL',
                                                                                 'Feedback Status-Update: Müll nicht abgeholt',
                                                                                 'Sehr geehrte/r Benutzer, Ihr Feedback "Müll nicht abgeholt" wird derzeit bearbeitet. Mit freundlichen Grüßen, Ihr Team Wels',
                                                                                 false,
                                                                                 (SELECT id FROM benutzer WHERE mail = 'charlie.test@htl.at')
                                                                             );
=======
-- Import / Schema-Skript für das ERD (Benutzer, Thema, Status, Kategorie, Feedback, Bild, feedback_kategorie)
-- Erstellt Tabellen, Foreign Keys und fügt Beispiel-Daten ein.
-- Läuft auf PostgreSQL.

-- Reihenfolge beachten: erst dependent objects löschen, dann neu anlegen
DROP TABLE IF EXISTS feedback_kategorie;
DROP TABLE IF EXISTS bild;
DROP TABLE IF EXISTS feedback;
DROP TABLE IF EXISTS kategorie;
DROP TABLE IF EXISTS status;
DROP TABLE IF EXISTS thema;
DROP TABLE IF EXISTS benutzer;

-- Benutzer
CREATE TABLE benutzer (
                          id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
                          vorname VARCHAR(100) NOT NULL,
                          nachname VARCHAR(100) NOT NULL,
                          rolle VARCHAR(50) NOT NULL
);

-- Thema
CREATE TABLE thema (
                       id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
                       bezeichnung VARCHAR(150) NOT NULL
);

-- Status
CREATE TABLE status (
                        id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
                        bezeichnung VARCHAR(100) NOT NULL
);

-- Kategorie
CREATE TABLE kategorie (
                           id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
                           bezeichnung VARCHAR(150) NOT NULL
);

-- Feedback
CREATE TABLE feedback (
                          id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
                          betreff VARCHAR(255) NOT NULL,
                          beschreibung TEXT NOT NULL,
                          typ VARCHAR(100) NOT NULL,
                          status_id BIGINT REFERENCES status(id) ON DELETE SET NULL,
                          created_at TIMESTAMP WITHOUT TIME ZONE NOT NULL DEFAULT NOW(),
                          updated_at TIMESTAMP WITHOUT TIME ZONE NOT NULL DEFAULT NOW(),
                          user_id BIGINT REFERENCES benutzer(id) ON DELETE SET NULL,
                          thema_id BIGINT REFERENCES thema(id) ON DELETE SET NULL
);



-- Join-Table Feedback <-> Kategorie (ManyToMany)
CREATE TABLE feedback_kategorie (
                                    feedback_id BIGINT NOT NULL REFERENCES feedback(id) ON DELETE CASCADE,
                                    kategorie_id BIGINT NOT NULL REFERENCES kategorie(id) ON DELETE CASCADE,
                                    PRIMARY KEY (feedback_id, kategorie_id)
);

-- Indexes (optional, für bessere Performance bei Joins / Lookups)
CREATE INDEX idx_feedback_status ON feedback(status_id);
CREATE INDEX idx_feedback_user ON feedback(user_id);
CREATE INDEX idx_feedback_thema ON feedback(thema_id);
CREATE INDEX idx_feedback_kategorie_k ON feedback_kategorie(kategorie_id);

-- -------------------------
-- Beispiel-Daten einfügen
-- -------------------------

-- Statuswerte
INSERT INTO status (bezeichnung) VALUES
                                     ('Neu'),
                                     ('In Bearbeitung'),
                                     ('Erledigt');

-- Themen
INSERT INTO thema (bezeichnung) VALUES
                                    ('Infrastruktur'),
                                    ('Service'),
                                    ('IT');

-- Kategorien
INSERT INTO kategorie (bezeichnung) VALUES
                                        ('Sicherheit'),
                                        ('Sauberkeit'),
                                        ('Funktionalität'),
                                        ('Sonstiges');

-- Benutzer
INSERT INTO benutzer (vorname, nachname, rolle) VALUES
                                                    ('Alice', 'Muster', 'student'),
                                                    ('Bob', 'Beispiel', 'student'),
                                                    ('Charlie', 'Test', 'lehrer'),
                                                    ('Diana', 'Demo', 'admin');

-- Beispiel-Feedbacks
INSERT INTO feedback (betreff, beschreibung, typ, status_id, created_at, updated_at, user_id, thema_id)
VALUES
    ('Kaputte Tür', 'Die Tür im Raum 12 klemmt und lässt sich schwer öffnen.', 'Beschwerde', 1, NOW(), NOW(), 1, 1),
    ('Sauberkeit Mensa', 'In der Mensa liegen oft Essensreste auf dem Boden.', 'Beschwerde', 2, NOW(), NOW(), 2, 2),
    ('Tolles Update', 'Das neue Login-Feature funktioniert sehr gut.', 'Lob', 3, NOW(), NOW(), 3, 3),
    ('WLAN Aussetzer', 'Das WLAN bricht im Gebäude C mehrfach täglich ab.', 'Beschwerde', 1, NOW(), NOW(), 1, 3);



-- Kategorien-Zuordnungen (ManyToMany)
INSERT INTO feedback_kategorie (feedback_id, kategorie_id) VALUES
                                                               (1, 3), -- Kaputte Tür -> Funktionalität
                                                               (1, 4), -- Kaputte Tür -> Sonstiges
                                                               (2, 2), -- Sauberkeit Mensa -> Sauberkeit
                                                               (3, 4), -- Tolles Update -> Sonstiges
                                                               (4, 1); -- WLAN Aussetzer -> Sicherheit

-- -------------------------
-- Sequenzen / Identitys auf Max setzen
-- (setzt die internal sequence so dass nächste ID > max(id))
-- -------------------------
SELECT setval(pg_get_serial_sequence('benutzer','id'),
              GREATEST((SELECT COALESCE(MAX(id),0) FROM benutzer), 1), true);

SELECT setval(pg_get_serial_sequence('thema','id'),
              GREATEST((SELECT COALESCE(MAX(id),0) FROM thema), 1), true);

SELECT setval(pg_get_serial_sequence('status','id'),
              GREATEST((SELECT COALESCE(MAX(id),0) FROM status), 1), true);

SELECT setval(pg_get_serial_sequence('kategorie','id'),
              GREATEST((SELECT COALESCE(MAX(id),0) FROM kategorie), 1), true);

SELECT setval(pg_get_serial_sequence('feedback','id'),
              GREATEST((SELECT COALESCE(MAX(id),0) FROM feedback), 1), true);



-- Ende des Import-Skripts
>>>>>>> Stashed changes
